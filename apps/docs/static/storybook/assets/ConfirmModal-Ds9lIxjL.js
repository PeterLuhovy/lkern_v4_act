var Mt=Object.defineProperty;var It=(s,r,n)=>r in s?Mt(s,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[r]=n;var Pe=(s,r,n)=>It(s,typeof r!="symbol"?r+"":r,n);import{j as C}from"./jsx-runtime-D_zvdyIk.js";import{r as c,R as vt}from"./index-BKyFwriW.js";import{r as kt}from"./index-DcHVLjtu.js";import{w as Ve,t as ke,f as Ct,s as Rt,A as At,u as dt,c as xt,d as Dt,b as Ot,S as Nt}from"./ToastContext-ErSnUSL6.js";import{D as Ft}from"./DebugBar-C6YrkoDS.js";import{B as Ge}from"./Button-gnwGUMlA.js";import{I as bt}from"./Input-CFoEo-oh.js";import{F as Ut}from"./FormField-7Fj67rB9.js";function ue(){try{const s=localStorage.getItem("analytics-settings");if(s)return JSON.parse(s).logModalStack!==!1}catch{}return!0}class Bt{constructor(){Pe(this,"stack",[]);Pe(this,"baseZIndex",1e3)}push(r,n,a,t){this.stack=this.stack.filter(u=>u.id!==r);const y=this.baseZIndex+this.stack.length*10;return this.stack.push({id:r,parentId:n,onClose:a,onConfirm:t,zIndex:y}),ue()&&console.log("[ModalStack] PUSH:",r,"parent:",n,"zIndex:",y,"hasConfirm:",!!t,"stack:",this.stack.map(u=>u.id)),y}pop(r,n=!1){ue()&&console.log("[ModalStack] POP called:",r,"closeChildren:",n,"stack before:",this.stack.map(y=>y.id));const a=this.stack.findIndex(y=>y.id===r);if(a===-1)return ue()&&console.log("[ModalStack] POP ignored - not in stack:",r),!1;const t=this.stack[a];if(this.stack=this.stack.filter(y=>y.id!==r),ue()&&console.log("[ModalStack] POP removed:",r,"stack after:",this.stack.map(y=>y.id)),n){const y=this.stack.filter(u=>u.parentId===r);ue()&&console.log("[ModalStack] Closing children:",y.map(u=>u.id)),y.forEach(u=>{u.onClose&&(this.stack=this.stack.filter(m=>m.id!==u.id),u.onClose())})}return t.parentId!==void 0}closeModal(r){const n=this.stack.find(a=>a.id===r);return n?n.onClose?(ue()&&console.log("[ModalStack] closeModal - calling onClose:",r),n.onClose(),!0):(ue()&&console.log("[ModalStack] closeModal - no onClose callback:",r),!1):(ue()&&console.log("[ModalStack] closeModal - modal not found:",r),!1)}confirmModal(r){const n=this.stack.find(a=>a.id===r);return n?n.onConfirm?(ue()&&console.log("[ModalStack] confirmModal - calling onConfirm:",r),n.onConfirm(),!0):(ue()&&console.log("[ModalStack] confirmModal - no onConfirm callback:",r),!1):(ue()&&console.log("[ModalStack] confirmModal - modal not found:",r),!1)}getTopmostModalId(){return this.stack.length===0?void 0:this.stack[this.stack.length-1].id}getZIndex(r){const n=this.stack.find(a=>a.id===r);return n==null?void 0:n.zIndex}has(r){return this.stack.some(n=>n.id===r)}size(){return this.stack.length}clear(){const r=[...this.stack];this.stack=[],r.forEach(n=>{n.onClose&&n.onClose()}),ue()&&console.log("[ModalStack] CLEAR - all modals closed")}}const Ye=new Bt,Re={maxRetries:3,takingLongerDelay:1500,attemptTimeout:5e3,retryDelay:5e3,debug:!0};let ut=!0;function ie(s,r,n){ut&&console.log(`[ServiceRetry:${s}] ${r}`)}function Xe(s){return new Promise(r=>setTimeout(r,s))}async function st(s,r,n="Operation timed out"){let a;const t=new Promise((y,u)=>{a=setTimeout(()=>u(new Error(n)),r)});try{const y=await Promise.race([s,t]);return a&&clearTimeout(a),y}catch(y){throw a&&clearTimeout(a),y}}async function Ze(s,r,n={}){var p,g,j,L,h,K;const{serviceName:a,maxRetries:t=Re.maxRetries,takingLongerDelay:y=Re.takingLongerDelay,attemptTimeout:u=Re.attemptTimeout,retryDelay:m=Re.retryDelay,debug:_=Re.debug}=r;ut=_;const B=performance.now();let f=0,x=!1,D;ie(a,`Starting retry logic (max ${t} retries, ${u}ms timeout)`),(p=n.onAttemptStart)==null||p.call(n),f++,ie(a,`Attempt 1 (initial)... (takingLonger: ${y}ms, timeout: ${u}ms)`);const i=performance.now(),O=st(s(),u,`${a} timeout`);let I=!1,A=!1;const S=Xe(y).then(()=>{var v;return A||(I=!0,x=!0,ie(a,`ğŸ“¢ SHOWING "taking longer" toast at ${Math.round(performance.now()-i)}ms`),(v=n.onTakingLonger)==null||v.call(n)),{type:"timer"}});let E;try{const v=await Promise.race([O.then($=>({type:"call",result:$})),S]);if(v.type==="call")A=!0,E=v.result,ie(a,`First attempt completed in ${Math.round(performance.now()-i)}ms (before "taking longer" timer)`);else{ie(a,"Timer fired, waiting for call to complete...");try{E=await O}catch($){E={success:!1,error:$ instanceof Error?$.message:"Unknown error",responseTime:Math.round(performance.now()-i)}}}}catch(v){E={success:!1,error:v instanceof Error?v.message:"Unknown error",responseTime:Math.round(performance.now()-i)}}if(E.success)return ie(a,`âœ… First attempt successful (${E.responseTime}ms)`),(g=n.onSuccess)==null||g.call(n),{success:!0,data:E.data,attempts:f,totalTime:Math.round(performance.now()-B),tookLonger:x};D=E.error,ie(a,`âŒ First attempt failed: ${D}`),I||(ie(a,'ğŸ“¢ Quick failure detected - showing "connection failed" toast'),(j=n.onQuickFailure)==null||j.call(n));const o=performance.now()-i,T=Math.max(0,m-o);T>0&&(ie(a,`â³ Waiting ${Math.round(T)}ms before first retry...`),await Xe(T)),ie(a,`ğŸ“¢ Starting retry loop at ${Math.round(performance.now()-i)}ms`);for(let v=1;v<=t;v++){f++,(L=n.onRetry)==null||L.call(n,v,t),ie(a,`ğŸ”„ Retry ${v}/${t}...`);try{const $=await st(s(),u,`${a} timeout`);if($.success)return ie(a,`âœ… Retry ${v} successful (${$.responseTime}ms)`),(h=n.onSuccess)==null||h.call(n),{success:!0,data:$.data,attempts:f,totalTime:Math.round(performance.now()-B),tookLonger:x};D=$.error,ie(a,`âŒ Retry ${v} failed: ${D}`)}catch($){D=$ instanceof Error?$.message:"Unknown error",ie(a,`âŒ Retry ${v} error: ${D}`)}v<t&&(ie(a,`â³ Waiting ${m}ms before next retry...`),await Xe(m))}const e=Math.round(performance.now()-B);return ie(a,`ğŸš« All ${t} retries failed after ${e}ms`),(K=n.onAllRetriesFailed)==null||K.call(n),{success:!1,error:D||"All retry attempts failed",attempts:f,totalTime:e,tookLonger:x}}const Pt=["password","passwd","pwd","token","access_token","refresh_token","api_key","apikey","secret","auth","authorization","ssn","social_security","credit_card","card_number","cvv","pin","iban","bank_account","private_key","session","cookie"];function Vt(s,r){const n=s.toLowerCase();if(Pt.some(y=>n.includes(y)))return"***REDACTED***";const t=String(r);return t.length>100?`${t.substring(0,100)}... (${t.length} chars)`:t}class jt{constructor(r,n){Pe(this,"startTime");this.debug=r,this.caller=n,this.startTime=performance.now()}formatElapsedTime(){return`[+${((performance.now()-this.startTime)/1e3).toFixed(3)}s]`}log(r,n){if(!this.debug)return;const a=this.formatElapsedTime();n!==void 0?console.log(`${a} [${this.caller}] ${r}`,n):console.log(`${a} [${this.caller}] ${r}`)}logSection(r){if(!this.debug)return;const n=this.formatElapsedTime();console.log("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"),console.log(`${n} [${this.caller}] ${r}`),console.log("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")}logHeader(r){if(!this.debug)return;const n=this.formatElapsedTime();console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),console.log(`${n} [${this.caller}] ${r}`),console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")}getElapsedSeconds(){return(performance.now()-this.startTime)/1e3}getElapsedFormatted(){return`${this.getElapsedSeconds().toFixed(3)}s`}}const _e={PING:5e3,HEALTH:1e4,TAKING_LONGER:1500},fe={HEALTH_COUNT:3,HEALTH_DELAY:5e3,VERIFICATION_COUNT:3,VERIFICATION_DELAY:2e3},it={DEFAULT_TTL:300*1e3};function Qe(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}let mt=!1,ft=()=>{};function Ht(s,r){mt=s,ft=r}function he(s,r){mt&&ft(s,r)}async function Kt(s,r,n,a,t,y,u,m,_,B,f="json",x,D){const i=!B&&t&&t.length>0,O=i||n==="POST"&&_;try{he(`${n} ${s}${r}`);const I={...y};u!==void 0&&(I["X-Permission-Level"]=String(u));let A;if(n==="GET"||n==="DELETE")A=void 0;else if(O){const o=new FormData;if(a&&o.append(m??"data",JSON.stringify(a)),_)for(const[T,e]of Object.entries(_))o.append(T,e);if(i&&t)for(const T of t)o.append("files",T),he(`   Added file: ${T.name} (${(T.size/1024).toFixed(1)} KB)`);A=o}else a&&(I["Content-Type"]="application/json",A=JSON.stringify(a));const S=await fetch(`${s}${r}`,{method:n,headers:I,body:A,signal:x});if(S.status===204)return he("Response: 204 No Content"),{success:!0,data:void 0,httpStatus:204};let E;try{if(f==="blob")if(D&&S.body){const o=S.headers.get("Content-Length"),T=o?parseInt(o,10):0,e=T>0;D({phase:"downloading",totalBytes:T,downloadedBytes:0,percentage:0,totalKnown:e});const p=S.body.getReader(),g=[];let j=0;for(;;){const{done:v,value:$}=await p.read();if(v)break;g.push($),j+=$.length;const ae=e?Math.round(j/T*100):0;D({phase:"downloading",totalBytes:T,downloadedBytes:j,percentage:ae,totalKnown:e})}D({phase:"processing",totalBytes:j,downloadedBytes:j,percentage:100,totalKnown:!0});const L=new Uint8Array(j);let h=0;for(const v of g)L.set(v,h),h+=v.length;const K=new Blob([L]);E=K,D({phase:"complete",totalBytes:K.size,downloadedBytes:K.size,percentage:100,totalKnown:!0}),he(`Response: ${S.status} (blob with progress, ${K.size} bytes)`)}else E=await S.blob(),he(`Response: ${S.status} (blob, ${E.size} bytes)`);else f==="text"?(E=await S.text(),he(`Response: ${S.status} (text, ${E.length} chars)`)):(E=await S.json(),he(`Response: ${S.status} (json)`))}catch(o){const T=o instanceof Error?o.message:"Response parsing failed";he(`Response parsing error: ${T}`),E={message:S.statusText,parsingError:T}}if(!S.ok){const o=E==null?void 0:E.detail;if(S.status===409){he("409 Conflict - detail:",o);const T=typeof o=="object"?o==null?void 0:o.locked_by:void 0;return he("409 Conflict - extracted locked_by:",T),{success:!1,error:"Resource is locked by another user",errorCode:"CONFLICT",httpStatus:409,data:{locked_by:T},rawResponse:E}}return S.status===503&&typeof o=="object"&&(o==null?void 0:o.error)==="minio_unavailable"?{success:!1,error:"MinIO storage is unavailable",errorCode:"MINIO_UNAVAILABLE_WITH_FILES",httpStatus:503,rawResponse:E}:S.status>=500?{success:!1,error:typeof o=="string"?Qe(o):"Service error",errorCode:"API_ERROR",httpStatus:S.status,rawResponse:E}:{success:!1,error:typeof o=="string"?Qe(o):`API returned ${S.status}`,errorCode:"VALIDATION_ERROR",httpStatus:S.status,rawResponse:E}}return{success:!0,data:E,httpStatus:S.status,rawResponse:E}}catch(I){if(I instanceof Error&&I.name==="AbortError")return{success:!1,error:"Request was cancelled",errorCode:"NETWORK_ERROR"};const A=I instanceof Error?I.message:"Unknown error";return{success:!1,error:Qe(A),errorCode:"NETWORK_ERROR"}}}let pt=!1,Je="ServiceWorkflow",ht=()=>{};function qt(s,r,n){pt=s,Je=r,ht=n}function U(s,r){pt&&ht(s,r)}function at(s){if(typeof s!="string"||!/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(s))return s;try{const n=new Date(s);return isNaN(n.getTime())?s:n.toISOString()}catch{return s}}async function Wt(s,r,n,a){s>1&&(U(`ğŸ”„ Verification retry attempt ${s}/${r}`),a==null||a(s,r),await new Promise(t=>setTimeout(t,n)))}async function zt(s,r,n,a,t,y,u){var A;const m=performance.now();let _=!1;const B=(y==null?void 0:y.length)??0;let f=B===0;const x=[];let D;if(!r.enabled)return{sqlVerified:!0,attachmentsVerified:!0,verificationTime:Math.round(performance.now()-m)};const i=r.maxRetries??fe.VERIFICATION_COUNT,O=r.retryDelay??fe.VERIFICATION_DELAY;let I=1;for(;I<=i;){await Wt(I,i,O,u);try{const S=r.getEndpoint(n);U(`ğŸ“‹ Verifying SQL record: GET ${s}${S}`);const E=r.timeout??5e3,o={};t!==void 0&&(o["X-Permission-Level"]=String(t));const T=await fetch(`${s}${S}`,{method:"GET",headers:o,signal:AbortSignal.timeout(E)});if(!T.ok)return U(`   SQL Record: âŒ NOT FOUND (status ${T.status})`),{sqlVerified:!1,attachmentsVerified:!1,verificationTime:Math.round(performance.now()-m)};const e=await T.json();if(_=!0,U("   SQL Record: âœ… EXISTS in database"),r.compareFields&&a){U("ğŸ” Field comparison (sent vs saved):");const L=[];for(const $ of r.compareFields){const ae=a[$],oe=e[$],ee=ae===void 0||ae===""?null:ae,H=oe===void 0||oe===""?null:oe,ce=at(ee),J=at(H),d=ce===J;L.push({field:$,sent:ee,saved:H,match:d});const M=ee===null?"null":`"${String(ee).substring(0,30)}${String(ee).length>30?"...":""}"`,w=H===null?"null":`"${String(H).substring(0,30)}${String(H).length>30?"...":""}"`;d?U(`   [âœ…] ${$.padEnd(14)} ${M}`):(U(`   [âŒ] ${$.padEnd(14)} sent: ${M}`),U(`                        saved: ${w}`))}const h=L.filter($=>$.match).length,K=L.length,v=h===K;D={results:L,matchCount:h,totalCount:K,allMatch:v},U(`   Field Result: ${v?"âœ…":"âš ï¸"} ${h}/${K} fields match`)}if(U(`   Attachments in response: ${((A=e.attachments)==null?void 0:A.length)||0}`),B>0&&y){U(`ğŸ“ Verifying MinIO attachments (expected: ${B})...`);const L=new Map;for(const h of y)L.set(h.name,h.size);if(e.attachments&&e.attachments.length>0){for(const v of e.attachments)try{const $=r.getEndpoint(n),oe=(await fetch(`${s}${$}/attachments/${v.file_name}`,{method:"HEAD",signal:AbortSignal.timeout(3e3)})).ok,ee=v.file_size||void 0,H=L.get(v.file_name),ce=H!==void 0&&ee!==void 0?H===ee:void 0;x.push({fileName:v.file_name,available:oe,expectedSize:H,actualSize:ee,sizeMatch:ce});const J=d=>d!==void 0?`${(d/1024).toFixed(1)} KB`:"?";U(oe?ce===!0?`   [âœ…] ${v.file_name} (${J(ee)}) âœ… size match`:ce===!1?`   [âš ï¸] ${v.file_name} - size mismatch! DB: ${J(ee)}, Sent: ${J(H)}`:`   [âœ…] ${v.file_name} (${J(ee)}) - size check skipped`:`   [âŒ] ${v.file_name} - NOT FOUND in MinIO`)}catch($){x.push({fileName:v.file_name,available:!1}),U(`   [âŒ] ${v.file_name} (error: ${$ instanceof Error?$.message:"unknown"})`)}const h=x.every(v=>v.available),K=x.every(v=>v.sizeMatch!==!1);f=h&&K,U(`   MinIO Result: ${f?"âœ… ALL FILES VERIFIED":"âŒ VERIFICATION FAILED"}`),h||U("      - Some files not accessible"),K||U("      - Some file sizes don't match")}else U(`   âš ï¸ WARNING: Expected ${B} attachments but API returned 0`),U("   (Backend GET may not include attachments array)"),f=!1}else U("ğŸ“ MinIO: No attachments to verify (none uploaded)");const p=Math.round(performance.now()-m);U(`â±ï¸ Verification completed in ${p}ms`);const g=(D==null?void 0:D.allMatch)??!0;if(_&&f&&g)return U(`âœ… Verification successful on attempt ${I}`),{sqlVerified:_,attachmentsVerified:f,attachmentResults:x.length>0?x:void 0,fieldComparison:D,verificationTime:p};if(I===i)return U(`âŒ Verification failed after ${i} attempts`),{sqlVerified:_,attachmentsVerified:f,attachmentResults:x.length>0?x:void 0,fieldComparison:D,verificationTime:p};I++}catch(S){const E=S instanceof Error?S.message:"Verification error";if(U(`   âŒ Verification error on attempt ${I}: ${E}`),I===i)return U(`âŒ Verification failed after ${i} attempts`),{sqlVerified:!1,attachmentsVerified:!1,verificationTime:Math.round(performance.now()-m)};I++}}return{sqlVerified:!1,attachmentsVerified:!1,verificationTime:Math.round(performance.now()-m)}}async function Gt(s,r,n,a){var y,u;U("ğŸ” Pre-delete verification: checking attachments...");const t={success:!0,missingInMinio:[],orphanedInMinio:[],dbAttachments:0,minioFiles:0,hasIntegrityIssues:!1};try{const m=r.getVerifyEndpoint(r.entityId);U(`   GET ${s}${m}`);const _={};n!==void 0&&(_["X-Permission-Level"]=String(n));const B=await fetch(`${s}${m}`,{method:"GET",headers:_,signal:AbortSignal.timeout(1e4)});if(!B.ok)return U(`   âš ï¸ Verify endpoint failed (status ${B.status}) - proceeding without verification`),t;const f=await B.json();if(t.dbAttachments=((y=f.db_attachments)==null?void 0:y.length)||0,t.minioFiles=((u=f.minio_files)==null?void 0:u.length)||0,t.missingInMinio=f.missing_in_minio||[],t.orphanedInMinio=f.orphaned_in_minio||[],U(`   DB attachments: ${t.dbAttachments}`),U(`   MinIO files: ${t.minioFiles}`),U(`   Missing in MinIO: ${t.missingInMinio.length}`),U(`   Orphaned in MinIO: ${t.orphanedInMinio.length}`),t.missingInMinio.length>0&&(t.hasIntegrityIssues=!0,U(`   âš ï¸ DATA INTEGRITY ISSUE: ${t.missingInMinio.length} files in DB but missing from MinIO`),a)){const x={event_type:"data_integrity.missing_attachment",source_service:Je,source_entity:{type:r.entityType,id:r.entityId,code:r.entityCode},detected_at:new Date().toISOString(),details:{missing_files:t.missingInMinio,expected_location:`minio/${r.entityType}s/${r.entityId}/`},issue_data:{title:r.entityCode?`Missing attachments in ${r.entityType} ${r.entityCode}`:"Missing attachments detected during delete",description:`Found ${t.missingInMinio.length} file(s) in database but missing from MinIO storage.

**Affected files:**
${t.missingInMinio.map(D=>`- ${D}`).join(`
`)}`,type:"BUG",severity:"MODERATE",category:"DATA_INTEGRITY",priority:"MEDIUM"}};U("   ğŸ“¤ Reporting data integrity issue..."),a(x)}if(t.orphanedInMinio.length>0&&(t.hasIntegrityIssues=!0,U(`   âš ï¸ DATA INTEGRITY ISSUE: ${t.orphanedInMinio.length} files in MinIO but not in DB`),a)){const x={event_type:"data_integrity.orphaned_attachment",source_service:Je,source_entity:{type:r.entityType,id:r.entityId,code:r.entityCode},detected_at:new Date().toISOString(),details:{orphaned_files:t.orphanedInMinio,expected_location:`minio/${r.entityType}s/${r.entityId}/`},issue_data:{title:r.entityCode?`Orphaned attachments in ${r.entityType} ${r.entityCode}`:"Orphaned attachments detected during delete",description:`Found ${t.orphanedInMinio.length} file(s) in MinIO storage but not in database records.

**Affected files:**
${t.orphanedInMinio.map(D=>`- ${D}`).join(`
`)}`,type:"BUG",severity:"MINOR",category:"DATA_INTEGRITY",priority:"LOW"}};U("   ğŸ“¤ Reporting data integrity issue (orphaned files)..."),a(x)}return U(`   Status: ${f.status}`),t}catch(m){const _=m instanceof Error?m.message:"Unknown error";return U(`   âš ï¸ Verify failed: ${_} - proceeding without verification`),t}}let je=!1,gt=()=>{};function Yt(s,r){je=s,gt=r}function ye(s,r){je&&gt(s,r)}async function Xt(s,r,n,a,t){const y=performance.now();if(r){const O=async()=>{const S=performance.now();try{const E=await fetch(`${s}/ping`,{method:"GET"}),o=Math.round(performance.now()-S);return{success:E.ok,data:{alive:E.ok},responseTime:o}}catch(E){return{success:!1,error:E instanceof Error?E.message:"Unknown error",responseTime:Math.round(performance.now()-S)}}},I={onTakingLonger:t==null?void 0:t.onTakingLonger,onQuickFailure:t==null?void 0:t.onQuickFailure,onRetry:t==null?void 0:t.onRetry,onSuccess:t==null?void 0:t.onServiceAlive,onAllRetriesFailed:t==null?void 0:t.onServiceDown},A=await Ze(O,{serviceName:"Service",maxRetries:fe.HEALTH_COUNT,takingLongerDelay:_e.TAKING_LONGER,attemptTimeout:_e.PING,retryDelay:fe.HEALTH_DELAY,debug:je},I);if(!A.success)return ye("âŒ Service is not responding after all retries"),{service:{status:"unhealthy",responseTime:A.totalTime,error:A.error},sql:{status:"skipped",error:"Service unavailable"},minio:{status:"skipped",error:"Service unavailable"},overall:"unhealthy",totalTime:A.totalTime};ye("âœ… Service is alive")}let u={status:"skipped"};if(n){const O=async()=>{var E,o,T,e,p,g;const S=performance.now();try{const j=await fetch(`${s}/health`,{method:"GET"}),L=Math.round(performance.now()-S),h=await j.json(),K=((o=(E=h.dependencies)==null?void 0:E.sql)==null?void 0:o.status)==="healthy"?"healthy":"unhealthy";return{success:K==="healthy",data:{status:K,responseTime:((e=(T=h.dependencies)==null?void 0:T.sql)==null?void 0:e.responseTime)||L,error:(g=(p=h.dependencies)==null?void 0:p.sql)==null?void 0:g.error},responseTime:L}}catch(j){return{success:!1,error:j instanceof Error?j.message:"Unknown error",responseTime:Math.round(performance.now()-S)}}},I={onTakingLonger:t==null?void 0:t.onTakingLonger,onQuickFailure:t==null?void 0:t.onQuickFailure,onRetry:t==null?void 0:t.onRetry,onAllRetriesFailed:t==null?void 0:t.onServiceDown};ye("ğŸ” Checking SQL Database...");const A=await Ze(O,{serviceName:"SQL Database",maxRetries:fe.HEALTH_COUNT,takingLongerDelay:_e.TAKING_LONGER,attemptTimeout:_e.HEALTH,retryDelay:fe.HEALTH_DELAY,debug:je},I);if(u=A.data??{status:"unhealthy",responseTime:A.totalTime,error:A.error},u.status!=="healthy"){ye(`âŒ SQL Database is unhealthy: ${u.error}`),ye("â­ï¸ MinIO check skipped (SQL unavailable - no point checking storage without database)");const S=Math.round(performance.now()-y);return{service:{status:"healthy",responseTime:S},sql:u,minio:{status:"skipped",error:"SQL unavailable"},overall:"degraded",totalTime:S}}ye("âœ… SQL Database is healthy")}let m={status:"skipped"};if(a){const O=async()=>{var E,o,T,e,p,g;const S=performance.now();try{const j=await fetch(`${s}/health`,{method:"GET"}),L=Math.round(performance.now()-S),h=await j.json(),K=((o=(E=h.dependencies)==null?void 0:E.minio)==null?void 0:o.status)==="healthy"?"healthy":"unhealthy";return{success:K==="healthy",data:{status:K,responseTime:((e=(T=h.dependencies)==null?void 0:T.minio)==null?void 0:e.responseTime)||L,error:(g=(p=h.dependencies)==null?void 0:p.minio)==null?void 0:g.error},responseTime:L}}catch(j){return{success:!1,error:j instanceof Error?j.message:"Unknown error",responseTime:Math.round(performance.now()-S)}}};ye("ğŸ” Checking MinIO Storage...");const I=performance.now(),A=await O();m=A.data??{status:"unhealthy",responseTime:Math.round(performance.now()-I),error:A.error},m.status==="healthy"?ye("âœ… MinIO Storage is healthy"):ye(`âš ï¸ MinIO Storage is unavailable: ${m.error} (optional - continuing)`)}const _=Math.round(performance.now()-y),B=u.status==="unhealthy",f=m.status==="unhealthy",x=u.status==="skipped",D=m.status==="skipped";let i;return B||f?i="degraded":x||D?i="skipped":i="healthy",{service:{status:"healthy",responseTime:_},sql:u,minio:m,overall:i,totalTime:_}}async function et(s){var G,N,k,ne,X,Q,me,z,Y,te;const{baseUrl:r,endpoint:n,method:a,data:t,files:y,headers:u,permissionLevel:m,formDataRole:_,formDataFields:B,healthChecks:f,verification:x,deleteVerification:D,callbacks:i,debug:O=!1,caller:I="ServiceWorkflow",showToasts:A=!1,language:S="sk",responseType:E="json"}=s,o=new jt(O,I);Yt(O,o.log.bind(o)),Ht(O,o.log.bind(o)),qt(O,I,o.log.bind(o));const T=S==="en"?Ct:Rt;let e;const p={onServiceAlive:()=>{var R;e&&(ke.hide(e),e=void 0),(R=i==null?void 0:i.onServiceAlive)==null||R.call(i)},onServiceDown:()=>{var R;e&&(ke.hide(e),e=void 0),A&&ke.show(T.storageOperations.messages.serviceDown,{type:"error",duration:2e4}),(R=i==null?void 0:i.onServiceDown)==null||R.call(i)},onTakingLonger:()=>{var R;A&&(e=ke.show(T.storageOperations.messages.takingLonger,{type:"warning",duration:0})),(R=i==null?void 0:i.onTakingLonger)==null||R.call(i)},onQuickFailure:()=>{var R;A&&ke.show(T.storageOperations.messages.connectionFailed,{type:"warning",duration:2e4}),(R=i==null?void 0:i.onQuickFailure)==null||R.call(i)},onHealthRetry:(R,q)=>{var se;A&&ke.show(T.storageOperations.messages.retrying.replace("{attempt}",String(R)).replace("{max}",String(q)),{type:"info",duration:2e4}),(se=i==null?void 0:i.onHealthRetry)==null||se.call(i,R,q)},onSuccess:i==null?void 0:i.onSuccess,onError:i==null?void 0:i.onError,onDataIntegrityIssue:i==null?void 0:i.onDataIntegrityIssue,onOptimisticUpdate:i==null?void 0:i.onOptimisticUpdate,onVerificationRetry:i==null?void 0:i.onVerificationRetry},g=y&&y.length>0,j=new Date().toISOString();o.logHeader(`ğŸš€ ${a} WORKFLOW`),o.logSection("ğŸ“Œ WORKFLOW CONTEXT"),o.log(`   Timestamp:   ${j}`),o.log(`   Caller:      ${I}`),o.log(`   Debug Mode:  ${O?"ON":"OFF"}`),o.logSection("ğŸ“¡ REQUEST INFO"),o.log(`   Base URL:    ${r}`),o.log(`   Endpoint:    ${n}`),o.log(`   Method:      ${a}`),m!==void 0&&o.log(`   Permission:  ${m}`);const L=t&&typeof t=="object"?Object.keys(t).length:0;if(a==="PUT"||a==="PATCH"?o.logSection(`ğŸ“ FIELDS TO UPDATE (${L})`):a==="POST"?o.logSection(`ğŸ“ NEW RECORD DATA (${L} fields)`):o.logSection("ğŸ“ REQUEST DATA"),t&&typeof t=="object"){const R=t;for(const[q,se]of Object.entries(R))if(se==null)o.log(`   ${q.padEnd(14)} (not set)`);else{const ge=Vt(q,se);o.log(`   ${q.padEnd(14)} ${ge}`)}}g&&o.log(`   + ${y==null?void 0:y.length} file(s) to upload`),g&&y&&y.forEach((R,q)=>o.log(`      [${q+1}] ${R.name} (${(R.size/1024).toFixed(1)} KB, ${R.type})`)),o.logSection("STEP 1: HEALTH CHECK"),o.log(`   Automatic retry: up to ${fe.HEALTH_COUNT}x (${_e.TAKING_LONGER}msâ†’"taking longer", ${_e.PING}ms timeout, ${fe.HEALTH_DELAY}ms between)`);const h=await Xt(r,(f==null?void 0:f.ping)??!0,(f==null?void 0:f.sql)??!0,(f==null?void 0:f.minio)??!1,{onServiceAlive:p.onServiceAlive,onServiceDown:p.onServiceDown,onTakingLonger:p.onTakingLonger,onQuickFailure:p.onQuickFailure,onRetry:p.onHealthRetry});if(o.logSection("ğŸ¥ RESULTS"),o.log(`   Service:     ${h.service.status==="healthy"?"âœ…":"âŒ"} ${h.service.status.toUpperCase()} (${h.service.responseTime}ms)`),o.log(`   SQL Database: ${h.sql.status==="healthy"?"âœ…":h.sql.status==="skipped"?"â­ï¸":h.sql.status==="unknown"?"â“":"âŒ"} ${h.sql.status.toUpperCase()} (${h.sql.responseTime||0}ms)${h.sql.error?` [${h.sql.error}]`:""}`),o.log(`   MinIO Storage: ${h.minio.status==="healthy"?"âœ…":h.minio.status==="skipped"?"â­ï¸":h.minio.status==="unknown"?"â“":"âŒ"} ${h.minio.status.toUpperCase()} (${h.minio.responseTime||0}ms)${h.minio.error?` [${h.minio.error}]`:""}`),o.log(`   Overall: ${h.overall.toUpperCase()}`),h.service.status==="unhealthy"){o.log("âŒ Service down - cannot proceed");const R=o.getElapsedFormatted();return o.log(`â±ï¸  Total workflow time: ${R}s`),(G=p.onError)==null||G.call(p,"Service is not available","SERVICE_DOWN"),{success:!1,error:"Service is not available",errorCode:"SERVICE_DOWN",totalTime:h.totalTime}}if(h.sql.status==="unhealthy"){o.log("âŒ SQL Database down - cannot proceed");const R=o.getElapsedFormatted();return o.log(`â±ï¸  Total workflow time: ${R}s`),(N=p.onError)==null||N.call(p,"Database is not available","SQL_DOWN"),{success:!1,error:"Database is not available",errorCode:"SQL_DOWN",totalTime:h.totalTime}}let K=h.minio.status==="healthy";const v=h.minio.status==="skipped";if(!K&&!v&&g&&(f!=null&&f.minio)){o.log("âš ï¸ MinIO unhealthy + user has files â†’ retrying MinIO check...");const R=async()=>{var Ee,$e,we,ve,Se,Le;const ge=performance.now();try{const Me=await fetch(`${r}/health`,{method:"GET"}),Ae=Math.round(performance.now()-ge),Ie=await Me.json(),xe=(($e=(Ee=Ie.dependencies)==null?void 0:Ee.minio)==null?void 0:$e.status)==="healthy"?"healthy":"unhealthy";return{success:xe==="healthy",data:{status:xe,responseTime:((ve=(we=Ie.dependencies)==null?void 0:we.minio)==null?void 0:ve.responseTime)||Ae,error:(Le=(Se=Ie.dependencies)==null?void 0:Se.minio)==null?void 0:Le.error},responseTime:Ae}}catch(Me){return{success:!1,error:Me instanceof Error?Me.message:"Unknown error",responseTime:Math.round(performance.now()-ge)}}},q={onTakingLonger:i==null?void 0:i.onTakingLonger,onRetry:i==null?void 0:i.onHealthRetry};o.log("ğŸ”„ Starting MinIO retry loop (3 attempts)...");const se=await Ze(R,{serviceName:"MinIO Storage",maxRetries:fe.HEALTH_COUNT,takingLongerDelay:_e.TAKING_LONGER,attemptTimeout:_e.HEALTH,retryDelay:fe.HEALTH_DELAY,debug:O},q);if(se.success)o.log("âœ… MinIO became available after retry!"),K=!0,h.minio=se.data||{status:"healthy",responseTime:se.totalTime},h.overall="healthy";else{o.log("âŒ MinIO still unavailable after 3 retries â†’ showing modal");const ge=`MinIO storage is unavailable after ${fe.HEALTH_COUNT} retries. ${y==null?void 0:y.length} file(s) cannot be uploaded.`,Ee=o.getElapsedFormatted();return o.log(`â±ï¸  Total workflow time: ${Ee}s`),(k=p.onError)==null||k.call(p,ge,"MINIO_UNAVAILABLE_WITH_FILES"),{success:!1,error:ge,errorCode:"MINIO_UNAVAILABLE_WITH_FILES",totalTime:h.totalTime}}}v&&!g||!K&&!g&&o.log("âš ï¸ MinIO unhealthy - no files to upload, continuing without storage"),o.log("âœ… Can proceed"),a==="DELETE"&&(D!=null&&D.enabled)&&(o.logSection("STEP 1.5: PRE-DELETE VERIFICATION"),await Gt(r,D,m,i==null?void 0:i.onDataIntegrityIssue));const{cache:$,optimisticUpdates:ae}=s;if($!=null&&$.enabled&&!($!=null&&$.skipCache)&&a==="GET"){o.logSection("STEP 1.7: CACHE LOOKUP");const R=$.cacheKey??await Ve.generateKey(n,a,t);o.log(`ğŸ” Cache key: ${R}`);const q=Ve.get(R);if(q){const se=$.ttl||it.DEFAULT_TTL;return o.log(`âœ… Cache HIT - returning cached response (TTL: ${se}ms)`),o.log(`â±ï¸  Total workflow time: ${o.getElapsedFormatted()}s`),o.logHeader("âœ… WORKFLOW COMPLETE (from cache)"),{success:!0,data:q,statusCode:200,verified:!1,totalTime:h.totalTime}}o.log("âŒ Cache MISS - proceeding with API call")}let oe;if(ae&&(i!=null&&i.onOptimisticUpdate)){o.logSection("STEP 1.8: OPTIMISTIC UPDATE"),o.log("ğŸ“¤ Triggering optimistic UI update BEFORE API call");const R=(ne=p.onOptimisticUpdate)==null?void 0:ne.call(p,t);typeof R=="function"?(oe=R,o.log("âœ… Rollback function registered")):o.log("â„¹ï¸  No rollback function provided")}o.logSection(`STEP 2: ${a} ${n}`);const ee=!K;i!=null&&i.onProgress&&i.onProgress({phase:"downloading",totalBytes:0,downloadedBytes:0,percentage:0,totalKnown:!1});const H=await Kt(r,n,a,t,y,u,m,_,B,ee,E,void 0,i==null?void 0:i.onProgress);if(!H.success)return o.log(`âŒ API failed: ${H.error}`),oe&&(o.log("ğŸ”„ Rolling back optimistic update"),oe()),(X=p.onError)==null||X.call(p,H.error??"Unknown API error",H.errorCode??"API_ERROR"),{success:!1,error:H.error,errorCode:H.errorCode,statusCode:H.httpStatus,totalTime:h.totalTime,data:H.data,rawResponse:H.rawResponse};const ce=H.data,J=!!(g&&K);if(o.log(`âœ… ${a} successful`),o.log(`   Status: ${H.httpStatus}`),o.log(`   Files uploaded: ${J?"yes":"no"}`),$!=null&&$.enabled&&!($!=null&&$.skipCache)&&a==="GET"&&H.success&&H.data){const R=$.cacheKey??await Ve.generateKey(n,a,t),q=$.ttl||it.DEFAULT_TTL;Ve.set(R,H.data,q),o.log(`ğŸ’¾ Cached response (key: ${R}, TTL: ${q}ms)`)}let d;x!=null&&x.enabled&&(o.logSection("STEP 3: VERIFICATION"),d=await zt(r,x,ce,t,m,J?y:void 0,p.onVerificationRetry));const M=h.totalTime,w=((Q=d==null?void 0:d.fieldComparison)==null?void 0:Q.allMatch)??!0,P=(d==null?void 0:d.sqlVerified)??!0,V=(d==null?void 0:d.attachmentsVerified)??!0,re=P&&V&&w;if(o.logSection("ğŸ“Š SUMMARY"),o.log(`   Status:      ${H.httpStatus}`),o.log(`   SQL:         ${d!=null&&d.sqlVerified?"âœ… VERIFIED":x!=null&&x.enabled?"âŒ FAILED":"â­ï¸ SKIPPED"}`),o.log(`   Fields:      ${d!=null&&d.fieldComparison?(w?"âœ…":"âŒ")+` ${d.fieldComparison.matchCount}/${d.fieldComparison.totalCount}`:"â– N/A"}`),o.log(`   MinIO:       ${J?V?"âœ… VERIFIED":"âŒ FAILED":"â– N/A (no files)"}`),x!=null&&x.enabled&&!re){const R=[];P||R.push("SQL record not found"),w||R.push(`Fields mismatch (${(me=d==null?void 0:d.fieldComparison)==null?void 0:me.matchCount}/${(z=d==null?void 0:d.fieldComparison)==null?void 0:z.totalCount})`),!V&&J&&R.push("Attachments not verified");const q=`Verification failed: ${R.join(", ")}`;o.log(`âŒ ${q}`);const se=o.getElapsedFormatted();return o.log(`â±ï¸  Total workflow time: ${se}s`),o.logHeader("âŒ WORKFLOW FAILED (VERIFICATION)"),(Y=p.onError)==null||Y.call(p,q,"VERIFICATION_FAILED"),{success:!1,data:ce,error:q,errorCode:"VERIFICATION_FAILED",statusCode:H.httpStatus,filesUploaded:J,verified:!1,totalTime:M}}const le=o.getElapsedFormatted();return o.log(`â±ï¸  Total workflow time: ${le}s`),o.logHeader("âœ… WORKFLOW COMPLETE"),(te=p.onSuccess)==null||te.call(p,ce),{success:!0,data:ce,statusCode:H.httpStatus,filesUploaded:J,verified:re,totalTime:M}}const Qt={trackMouse:!0,trackKeyboard:!0,trackDrag:!0,logToConsole:!0,trackTiming:!0},Zt=(s,r="page",n={})=>{const a=c.useContext(At),t=a?{...a.settings,...n}:{...Qt,...n},u=`[Analytics][${r.charAt(0).toUpperCase()+r.slice(1)}][${s}]`,m=c.useCallback((d,M)=>{t.logToConsole&&console.log(`${u} ${d}`,M||"")},[u,t.logToConsole]),[_,B]=c.useState(null),f=c.useRef(null),[x,D]=c.useState("0.0s"),[i,O]=c.useState("-"),[I,A]=c.useState(0),[S,E]=c.useState(0),o=c.useRef(0),T=c.useRef(0),e=c.useRef(0),p=c.useRef(null),g=c.useRef(null),j=c.useRef(null),L=c.useRef(null),h=c.useCallback(()=>{if(f.current&&!f.current.endTime){m("Session already active, ignoring start request");return}const d=Date.now(),M={sessionId:`${s}-${d}`,pageName:s,startTime:d,clickEvents:[],keyboardEvents:[]};f.current=M,B(M),D("0.0s"),O("-"),A(0),E(0),o.current=0,T.current=0,e.current=0,m("Session started:",{sessionId:M.sessionId})},[s,m]),K=c.useCallback(d=>{if(!f.current)return;L.current&&(clearTimeout(L.current),L.current=null);const M=Date.now(),w=M-f.current.startTime,P={...f.current,endTime:M,outcome:d,totalDuration:w};f.current=P,B(P),m("Session ended:",{sessionId:P.sessionId,outcome:d,duration:`${(w/1e3).toFixed(1)}s`,clicks:P.clickEvents.length,keyboard:P.keyboardEvents.length}),L.current=setTimeout(()=>{f.current=null,B(null),L.current=null},100)},[m]),v=c.useCallback(()=>{L.current&&(clearTimeout(L.current),L.current=null),f.current=null,B(null),D("0.0s"),O("-"),A(0),E(0),o.current=0,T.current=0,e.current=0},[]),$=c.useCallback((d,M,w)=>{var G;if(!t.trackMouse||!f.current)return;const P=Date.now(),V=(w==null?void 0:w.type)==="mousedown"?"mousedown":(w==null?void 0:w.type)==="mouseup"?"mouseup":"click";if(V==="mousedown"){p.current={timestamp:P,element:d,elementType:M,coordinates:w?{x:w.clientX,y:w.clientY}:void 0};return}if(V==="mouseup"&&p.current){const N=p.current,k=P-N.timestamp,ne=T.current?N.timestamp-T.current:void 0;let X=!1;if(N.coordinates&&w){const z=Math.abs(w.clientX-N.coordinates.x),Y=Math.abs(w.clientY-N.coordinates.y);X=z>5||Y>5}const Q=((G=window.getSelection())==null?void 0:G.toString())||"";if(X&&Q.length>0&&w&&N.coordinates){const z=Math.abs(w.clientX-N.coordinates.x),Y=Math.abs(w.clientY-N.coordinates.y),te=Math.sqrt(z*z+Y*Y);m("Text selection",{element:N.element,elementType:N.elementType,selectedText:Q.length>50?Q.substring(0,50)+"...":Q,selectedLength:`${Q.length} chars`,duration:`${k}ms`,distance:`${Math.round(te)}px`,deltaX:`${z}px`,deltaY:`${Y}px`}),p.current=null;return}if(X&&w&&N.coordinates){const z=Math.abs(w.clientX-N.coordinates.x),Y=Math.abs(w.clientY-N.coordinates.y),te=Math.sqrt(z*z+Y*Y);m("Drag operation",{element:N.element,elementType:N.elementType,duration:`${k}ms`,distance:`${Math.round(te)}px`,deltaX:`${z}px`,deltaY:`${Y}px`,startCoords:N.coordinates,endCoords:{x:w.clientX,y:w.clientY}}),p.current=null;return}if(k<500&&!X){const z={timestamp:N.timestamp,element:N.element,elementType:N.elementType,coordinates:N.coordinates,timeSinceLastClick:ne,eventType:"click"};f.current.clickEvents.push(z),T.current=N.timestamp,o.current=P,A(Y=>Y+1),m("Click",{element:N.element,elementType:N.elementType,duration:`${k}ms`,coordinates:N.coordinates,timeSinceLastClick:ne?`${(ne/1e3).toFixed(1)}s`:"first click"})}else{const z={timestamp:N.timestamp,element:N.element,elementType:N.elementType,coordinates:N.coordinates,timeSinceLastClick:ne,eventType:"mousedown"},Y={timestamp:P,element:d,elementType:M,coordinates:w?{x:w.clientX,y:w.clientY}:void 0,timeSinceLastClick:P-N.timestamp,eventType:"mouseup"};f.current.clickEvents.push(z,Y),T.current=P,o.current=P,A(te=>te+2),m("Mouse down",{element:N.element,elementType:N.elementType,coordinates:N.coordinates,timeSinceLastClick:ne?`${(ne/1e3).toFixed(1)}s`:"first click"}),m("Mouse up",{element:d,elementType:M,coordinates:w?{x:w.clientX,y:w.clientY}:void 0,duration:`${k}ms`})}p.current=null;return}const re=T.current?P-T.current:void 0,le={timestamp:P,element:d,elementType:M,coordinates:w?{x:w.clientX,y:w.clientY}:void 0,timeSinceLastClick:re,eventType:"click"};f.current.clickEvents.push(le),T.current=P,o.current=P,A(N=>N+1),m("Click",{element:d,elementType:M,timeSinceLastClick:re?`${(re/1e3).toFixed(1)}s`:"first click"})},[t.trackMouse,m]),ae=c.useCallback(d=>{if(!t.trackKeyboard||!f.current||d.repeat)return;const M=Date.now(),w=d.type==="keyup"?"keyup":"keydown";let P="unknown";if("target"in d&&d.target){const k=d.target;P=k.getAttribute("name")||k.id||k.tagName.toLowerCase()}const V={ctrl:d.ctrlKey,shift:d.shiftKey,alt:d.altKey,meta:d.metaKey};if(w==="keydown"){g.current={timestamp:M,key:d.key,code:d.code,modifiers:V,targetElement:P};return}if(w==="keyup"&&g.current){const k=g.current;if(k.key!==d.key){const z=e.current?k.timestamp-e.current:void 0,Y={timestamp:k.timestamp,key:k.key,code:k.code,modifiers:k.modifiers,eventType:"keydown",timeSinceLastKey:z,targetElement:k.targetElement};f.current.keyboardEvents.push(Y),e.current=k.timestamp,o.current=M,E(q=>q+1);const te=[];k.modifiers.ctrl&&te.push("Ctrl"),k.modifiers.shift&&te.push("Shift"),k.modifiers.alt&&te.push("Alt"),k.modifiers.meta&&te.push("Meta");const R=te.length>0?`${te.join("+")}+`:"";m("Key down",{key:`${R}${k.key}`,targetElement:k.targetElement,timeSinceLastKey:z?`${(z/1e3).toFixed(1)}s`:"first key"}),g.current=null;return}const ne=M-k.timestamp,X=e.current?k.timestamp-e.current:void 0,Q=[];V.ctrl&&Q.push("Ctrl"),V.shift&&Q.push("Shift"),V.alt&&Q.push("Alt"),V.meta&&Q.push("Meta");const me=Q.length>0?`${Q.join("+")}+`:"";if(ne<500){const z={timestamp:k.timestamp,key:k.key,code:k.code,modifiers:k.modifiers,eventType:"keydown",timeSinceLastKey:X,targetElement:k.targetElement};f.current.keyboardEvents.push(z),e.current=k.timestamp,o.current=M,E(Y=>Y+1),m("Keypress",{key:`${me}${d.key}`,duration:`${ne}ms`,targetElement:P,timeSinceLastKey:X?`${(X/1e3).toFixed(1)}s`:"first key"})}else{const z={timestamp:k.timestamp,key:k.key,code:k.code,modifiers:k.modifiers,eventType:"keydown",timeSinceLastKey:X,targetElement:k.targetElement},Y={timestamp:M,key:d.key,code:d.code,modifiers:V,eventType:"keyup",timeSinceLastKey:M-k.timestamp,targetElement:P};f.current.keyboardEvents.push(z,Y),e.current=M,o.current=M,E(te=>te+2),m("Key down",{key:`${me}${d.key}`,targetElement:P,timeSinceLastKey:X?`${(X/1e3).toFixed(1)}s`:"first key"}),m("Key up",{key:`${me}${d.key}`,duration:`${ne}ms`,targetElement:P})}g.current=null;return}const re=e.current?M-e.current:void 0,le={timestamp:M,key:d.key,code:d.code,modifiers:V,eventType:w,timeSinceLastKey:re,targetElement:P};f.current.keyboardEvents.push(le),e.current=M,o.current=M,E(k=>k+1);const G=[];V.ctrl&&G.push("Ctrl"),V.shift&&G.push("Shift"),V.alt&&G.push("Alt"),V.meta&&G.push("Meta");const N=G.length>0?`${G.join("+")}+`:"";m(`${w}`,{key:`${N}${d.key}`,targetElement:P,timeSinceLastKey:re?`${(re/1e3).toFixed(1)}s`:"first key"})},[t.trackKeyboard,m]),oe=c.useCallback((d,M)=>{if(!t.trackDrag||!f.current)return;const w=Date.now();j.current={timestamp:w,selectedText:d,coordinates:M},m("Drag started",{selectedText:d.length>50?d.substring(0,50)+"...":d,selectedLength:`${d.length} chars`,startCoords:M})},[t.trackDrag,m]),ee=c.useCallback(d=>{if(!t.trackDrag||!f.current||!j.current)return;const M=j.current,w=Date.now(),P=w-M.timestamp,V=Math.abs(d.x-M.coordinates.x),re=Math.abs(d.y-M.coordinates.y),le=Math.sqrt(V*V+re*re);m("Text drag (drop)",{selectedText:M.selectedText.length>50?M.selectedText.substring(0,50)+"...":M.selectedText,selectedLength:`${M.selectedText.length} chars`,duration:`${P}ms`,distance:`${Math.round(le)}px`,deltaX:`${V}px`,deltaY:`${re}px`,startCoords:M.coordinates,endCoords:d}),o.current=w,j.current=null},[t.trackDrag,m]);c.useEffect(()=>{if(!_)return;const d=setInterval(()=>{const M=Date.now(),w=f.current;if(!w){clearInterval(d);return}const P=M-w.startTime,V=Math.floor(P/1e3),re=Math.floor(P%1e3/100);if(D(`${V}.${re}s`),o.current>0){const le=M-o.current,G=Math.floor(le/1e3),N=Math.floor(le%1e3/100);O(`${G}.${N}s`)}},100);return()=>clearInterval(d)},[_==null?void 0:_.sessionId]);const H=c.useMemo(()=>!_||_.clickEvents.length<=1?0:_.clickEvents.slice(1).reduce((d,M)=>d+(M.timeSinceLastClick||0),0)/(_.clickEvents.length-1),[_==null?void 0:_.clickEvents,I]),ce={totalTime:x,timeSinceLastActivity:i,clickCount:I,keyboardCount:S,averageTimeBetweenClicks:H},J=c.useCallback(()=>f.current,[]);return c.useEffect(()=>()=>{L.current&&(clearTimeout(L.current),L.current=null)},[]),{startSession:h,endSession:K,resetSession:v,isSessionActive:_!==null&&!_.endTime,trackClick:$,trackKeyboard:ae,trackDragStart:oe,trackDragEnd:ee,metrics:ce,session:_,getSessionReport:J}};function Jt(){const[s,r]=c.useState({isOpen:!1,message:"",title:void 0,confirmButtonLabel:void 0,cancelButtonLabel:void 0,confirmKeyword:void 0,isDanger:!1}),n=c.useRef(null),a=c.useCallback(u=>new Promise(m=>{n.current=m;const _=typeof u=="string"?{message:u}:u;r({isOpen:!0,message:_.message||"",title:_.title,confirmButtonLabel:_.confirmButtonLabel,cancelButtonLabel:_.cancelButtonLabel,confirmKeyword:_.confirmKeyword,isDanger:_.isDanger||!1})}),[]),t=c.useCallback(()=>{n.current&&(n.current(!0),n.current=null),r(u=>({...u,isOpen:!1}))},[]),y=c.useCallback(()=>{n.current&&(n.current(!1),n.current=null),r(u=>({...u,isOpen:!1}))},[]);return{confirm:a,state:s,handleConfirm:t,handleCancel:y}}function eo(s){const{baseUrl:r,apiPrefix:n,userInfo:a,debug:t=!1,showToasts:y=!0,callbacks:u}=s,[m,_]=c.useState({hasLock:!1,isLockedByOther:!1,conflictInfo:void 0,isAcquiring:!1,isReleasing:!1}),B=c.useRef(null),f=c.useCallback(async i=>{var O,I,A,S,E,o;t&&console.log(`[useLocking] Acquiring lock for record: ${i}`),_(T=>({...T,isAcquiring:!0,hasLock:!1,isLockedByOther:!1,conflictInfo:void 0}));try{const T={user_id:a.userId},e=await et({baseUrl:r,endpoint:`${n}/${i}/lock`,method:"POST",data:T,debug:t,caller:"useLocking.acquireLock",showToasts:y,healthChecks:{ping:!0,sql:!0,minio:!1},verification:{enabled:!1,getEndpoint:()=>""},callbacks:{onError:(g,j)=>{var L;t&&console.error(`[useLocking] Error: ${g} (${j})`),(L=u==null?void 0:u.onError)==null||L.call(u,g,j)}}});if(e.success)return B.current=i,_({hasLock:!0,isLockedByOther:!1,conflictInfo:void 0,isAcquiring:!1,isReleasing:!1}),t&&console.log(`[useLocking] Lock acquired for record: ${i}`),(O=u==null?void 0:u.onLockAcquired)==null||O.call(u),{success:!0};if(e.statusCode===409){t&&(console.log("[useLocking] 409 Conflict - result.data:",e.data),console.log("[useLocking] 409 Conflict - result.rawResponse:",e.rawResponse));const g={isLocked:!0,lockedById:(A=(I=e.data)==null?void 0:I.locked_by)==null?void 0:A.id,lockedAt:(E=(S=e.data)==null?void 0:S.locked_by)==null?void 0:E.locked_at};return _({hasLock:!1,isLockedByOther:!0,conflictInfo:g,isAcquiring:!1,isReleasing:!1}),t&&console.log(`[useLocking] Lock conflict - locked by user ${g.lockedById}`),(o=u==null?void 0:u.onLockConflict)==null||o.call(u,g),{success:!1,conflictInfo:g,errorCode:"CONFLICT"}}_(g=>({...g,isAcquiring:!1}));const p=e.errorCode==="SERVICE_DOWN"?"SERVICE_DOWN":e.errorCode==="NETWORK_ERROR"?"NETWORK_ERROR":"UNKNOWN";return{success:!1,error:e.error,errorCode:p}}catch(T){const e=T instanceof Error?T.message:"Unknown error";return t&&console.error("[useLocking] Exception during lock acquisition:",T),_(p=>({...p,isAcquiring:!1})),{success:!1,error:e,errorCode:"UNKNOWN"}}},[r,n,a,t,y,u]),x=c.useCallback(async i=>{var O;if(B.current!==i)return t&&console.log(`[useLocking] Skip release - no lock held for record: ${i}`),{success:!0};t&&console.log(`[useLocking] Releasing lock for record: ${i}`),_(I=>({...I,isReleasing:!0}));try{const I=await et({baseUrl:r,endpoint:`${n}/${i}/lock`,method:"DELETE",headers:{"X-User-ID":a.userId,"X-Permission-Level":String(a.permissionLevel)},debug:t,caller:"useLocking.releaseLock",healthChecks:{ping:!1,sql:!0,minio:!1},verification:{enabled:!1,getEndpoint:()=>""},callbacks:{onError:(A,S)=>{t&&console.error(`[useLocking] Release error: ${A} (${S})`)}}});return B.current=null,_({hasLock:!1,isLockedByOther:!1,conflictInfo:void 0,isAcquiring:!1,isReleasing:!1}),I.success?(t&&console.log(`[useLocking] Lock released for record: ${i}`),(O=u==null?void 0:u.onLockReleased)==null||O.call(u),{success:!0}):(t&&console.warn(`[useLocking] Lock release failed: ${I.error}`),{success:!1,error:I.error})}catch(I){const A=I instanceof Error?I.message:"Unknown error";return t&&console.error("[useLocking] Exception during lock release:",I),B.current=null,_({hasLock:!1,isLockedByOther:!1,conflictInfo:void 0,isAcquiring:!1,isReleasing:!1}),{success:!1,error:A}}},[r,n,a,t,u]),D=c.useCallback(()=>{B.current=null,_({hasLock:!1,isLockedByOther:!1,conflictInfo:void 0,isAcquiring:!1,isReleasing:!1})},[]);return{acquireLock:f,releaseLock:x,lockState:m,resetState:D}}const to="Modal-module__modalOverlay___ednLt",oo="Modal-module__fadeIn___EgEj4",ro="Modal-module__modalContainer___HY5aD",no="Modal-module__modal--centered___zM-Kl",so="Modal-module__scaleIn___6-91Y",io="Modal-module__modal--sm___xqVLg",ao="Modal-module__modal--md___m0NIS",co="Modal-module__modal--lg___T9Inm",lo="Modal-module__modal--drawer___YnZ9V",uo="Modal-module__slideInRight___J8qVQ",mo="Modal-module__modal--fullscreen___QcjLH",fo="Modal-module__modalHeader___1wgvB",po="Modal-module__modalTitle___Zbogh",ho="Modal-module__modalCloseButton___kcsFb",go="Modal-module__modalBody___6pDsX",yo="Modal-module__modalFooter___NS4C-",Eo="Modal-module__modalFooterEnhanced___MECqa",To="Modal-module__modalFooterLeft___rGbYM",_o="Modal-module__modalFooterRight___Acvoc",$o="Modal-module__modalLoading___ZtUuz",wo="Modal-module__spinner___dOLdi",So="Modal-module__spin___0YWsh",Lo="Modal-module__lockBanner___jnd2s",Mo="Modal-module__lockIcon___4XRrZ",Io="Modal-module__forceUnlockButton___DjMoU",vo="Modal-module__lockLoading___7Pdh9",ko="Modal-module__lockError___NIcRu",Co="Modal-module__lockErrorIcon___uxbLN",Ro="Modal-module__lockErrorTitle___8zbzn",Ao="Modal-module__lockErrorMessage___fZsy6",xo="Modal-module__lockErrorButtons___GdqP7",Do="Modal-module__lockErrorButtonSecondary___3ogpl",Oo="Modal-module__lockErrorButtonPrimary___aKR1Z",No="Modal-module__readOnly___27Rse",Fo="Modal-module__lockLostBanner___YE000",bo="Modal-module__lockLostHint___2m4K1",W={modalOverlay:to,fadeIn:oo,modalContainer:ro,"modal--centered":"Modal-module__modal--centered___zM-Kl",modalCentered:no,scaleIn:so,"modal--sm":"Modal-module__modal--sm___xqVLg",modalSm:io,"modal--md":"Modal-module__modal--md___m0NIS",modalMd:ao,"modal--lg":"Modal-module__modal--lg___T9Inm",modalLg:co,"modal--drawer":"Modal-module__modal--drawer___YnZ9V",modalDrawer:lo,slideInRight:uo,"modal--fullscreen":"Modal-module__modal--fullscreen___QcjLH",modalFullscreen:mo,modalHeader:fo,modalTitle:po,modalCloseButton:ho,modalBody:go,modalFooter:yo,modalFooterEnhanced:Eo,modalFooterLeft:To,modalFooterRight:_o,modalLoading:$o,spinner:wo,spin:So,lockBanner:Lo,lockIcon:Mo,forceUnlockButton:Io,lockLoading:vo,lockError:ko,lockErrorIcon:Co,lockErrorTitle:Ro,lockErrorMessage:Ao,lockErrorButtons:xo,lockErrorButtonSecondary:Do,lockErrorButtonPrimary:Oo,readOnly:No,lockLostBanner:Fo,lockLostHint:bo};function Uo(s){return s!=null&&typeof s=="object"&&!vt.isValidElement(s)&&("left"in s||"right"in s)}function Bo(s){switch(s){case"top":return"flex-start";case"bottom":return"flex-end";case"center":default:return"center"}}const Po=({isOpen:s,onClose:r,onConfirm:n,hasUnsavedChanges:a=!1,modalId:t,parentModalId:y,size:u="md",title:m,children:_,footer:B,closeOnBackdropClick:f=!1,showCloseButton:x=!0,loading:D=!1,disableDrag:i=!1,alignment:O="center",overlayPadding:I="64px",zIndexOverride:A,className:S="",showDebugBar:E=!0,pageName:o,headerClassName:T,locking:e,onLockStatusChange:p})=>{const{t:g}=dt(),{theme:j}=xt(),L=Jt(),h=c.useRef(null),K=c.useRef(null),v=c.useRef(null),[$,ae]=c.useState(!1),[oe,ee]=c.useState(null),[H,ce]=c.useState({x:0,y:0}),J=c.useRef(!1),[d,M]=c.useState(1e3),[w,P]=c.useState(0),V=Zt(o||t,"modal");let re=!0,le=!1;try{const l=Dt();re=l.settings.showDebugBarModal,le=l.settings.logIssueWorkflow}catch{}const G=E&&re,N=j==="dark",{user:k,permissionLevel:ne}=Ot(),X=(e==null?void 0:e.enabled)===!0,{acquireLock:Q,releaseLock:me,lockState:z,resetState:Y}=eo({baseUrl:(e==null?void 0:e.lockApiUrl)||"",apiPrefix:(e==null?void 0:e.lockApiPrefix)||"",userInfo:{userId:k.id,userName:k.name,permissionLevel:ne},debug:le,showToasts:!0,callbacks:{onLockAcquired:()=>{var l;(l=e==null?void 0:e.onLockAcquired)==null||l.call(e),p==null||p(!1)},onLockConflict:l=>{var F;(F=e==null?void 0:e.onLockConflict)==null||F.call(e,{isLocked:!0,lockedById:l.lockedById,lockedAt:l.lockedAt}),p==null||p(!0)},onLockReleased:()=>{var l;(l=e==null?void 0:e.onLockReleased)==null||l.call(e)}}}),te=z.isLockedByOther,R=z.conflictInfo||null,q=z.hasLock,se=z.isAcquiring,[ge,Ee]=c.useState(!1),$e=c.useRef(!1),we=c.useRef(!1),ve=c.useRef(!1),Se=c.useRef(null),Le=c.useRef(Y),Me=c.useRef(me),Ae=c.useCallback(l=>{if(!l)return"";try{return new Date(l).toLocaleTimeString()}catch{return""}},[]),Ie=ne>=Nt,[xe,He]=c.useState(!1),[yt,tt]=c.useState(!1),Et=c.useCallback(async()=>{if(!(!X||!(e!=null&&e.recordId)||!(e!=null&&e.lockApiUrl)||!(e!=null&&e.lockApiPrefix)||!Ie)){tt(!0);try{(await et({baseUrl:e.lockApiUrl,endpoint:`${e.lockApiPrefix}/${e.recordId}/lock`,method:"DELETE",headers:{"X-User-ID":k.id,"X-Permission-Level":String(ne)},debug:!0,caller:"Modal.forceUnlock",healthChecks:{ping:!1,sql:!0,minio:!1},verification:{enabled:!1,getEndpoint:()=>""}})).success&&await Q(e.recordId)}finally{tt(!1),He(!1)}}},[X,e==null?void 0:e.recordId,e==null?void 0:e.lockApiUrl,e==null?void 0:e.lockApiPrefix,Ie,k.id,ne,Q]),[Te,De]=c.useState(!1),Oe=c.useRef(null),Ne=c.useRef(null),Ke=c.useRef(e),qe=c.useRef(q),ot=c.useRef(Te),We=c.useRef(Q);c.useEffect(()=>{Ke.current=e,qe.current=q,ot.current=Te,We.current=Q,Le.current=Y},[e,q,Te,Q,Y]),c.useEffect(()=>{if(!(!s||!X||!(e!=null&&e.recordId)||!(e!=null&&e.lockApiUrl)||!(e!=null&&e.lockApiPrefix)))return console.log("[Modal] Setting up lock monitoring for record:",e.recordId),Oe.current=setInterval(async()=>{const l=Ke.current,F=qe.current,b=ot.current;if(!(!(l!=null&&l.recordId)||!(l!=null&&l.lockApiUrl)||!(l!=null&&l.lockApiPrefix)))try{const Z=`${l.lockApiUrl}${l.lockApiPrefix}/${l.recordId}/lock`,de=await fetch(Z,{method:"GET",headers:{"X-User-ID":k.id}});if(de.ok){const pe=await de.json();console.log("[Modal] Lock status:",pe,"hasLock:",F),pe.is_locked&&pe.is_mine?b&&De(!1):pe.is_locked&&!pe.is_mine?F&&(console.log("[Modal] Lock lost! Someone else has it now."),De(!0),Le.current()):!pe.is_locked&&!F&&(console.log("[Modal] Lock is free, attempting to acquire..."),await We.current(l.recordId))}}catch{}},5e3),Ne.current=setInterval(async()=>{const l=Ke.current,F=qe.current;!(l!=null&&l.recordId)||F||(console.log("[Modal] 60s full workflow attempt..."),await We.current(l.recordId))},6e4),()=>{console.log("[Modal] Cleaning up lock monitoring intervals"),Oe.current&&(clearInterval(Oe.current),Oe.current=null),Ne.current&&(clearInterval(Ne.current),Ne.current=null)}},[s,X,e==null?void 0:e.recordId,e==null?void 0:e.lockApiUrl,e==null?void 0:e.lockApiPrefix,k.id]),c.useEffect(()=>{q&&Te&&De(!1)},[q,Te]);const Ce=c.useCallback(()=>{a?L.confirm({title:g("components.modalV3.confirmModal.unsavedChanges.title"),message:g("components.modalV3.confirmModal.unsavedChanges.message"),confirmButtonLabel:g("components.modalV3.confirmModal.unsavedChanges.confirmButton")}).then(l=>{l&&r()}):r()},[a,L,r,g]);c.useEffect(()=>(s&&G&&V.startSession(),()=>{G&&(V.isSessionActive&&V.endSession("dismissed"),V.resetSession())}),[s,G,o,t]),c.useEffect(()=>{if(s&&G&&v.current){const l=()=>{if(v.current){const F=v.current.offsetHeight;P(F)}};return l(),window.addEventListener("resize",l),()=>{window.removeEventListener("resize",l)}}else P(0)},[s,G]);const ze=c.useCallback(async()=>{if(!(e!=null&&e.recordId)||$e.current)return;$e.current=!0,Ee(!1);const l=await Q(e.recordId);$e.current=!1,!l.success&&l.errorCode!=="CONFLICT"&&Ee(!0)},[Q,e==null?void 0:e.recordId]);c.useEffect(()=>{var l,F;if(!s){we.current=!1,De(!1);return}if(!(!X||!(e!=null&&e.recordId)||!(e!=null&&e.lockApiUrl)||!(e!=null&&e.lockApiPrefix))){if((l=e.lockInfo)!=null&&l.isLocked){(F=e.onLockConflict)==null||F.call(e,e.lockInfo),p==null||p(!0);return}we.current||(we.current=!0,ze())}},[s,X,e==null?void 0:e.recordId,e==null?void 0:e.lockApiUrl,e==null?void 0:e.lockApiPrefix,e==null?void 0:e.lockInfo,ze]),c.useEffect(()=>{ve.current=q,Se.current=(e==null?void 0:e.recordId)||null,Le.current=Y,Me.current=me},[q,e==null?void 0:e.recordId,Y,me]),c.useEffect(()=>{s||(ve.current&&Se.current&&Me.current(Se.current),Le.current(),Ee(!1),$e.current=!1,we.current=!1,ve.current=!1,Se.current=null)},[s]),c.useEffect(()=>{if(s){const l=Ye.push(t,y,Ce,n);M(l)}return()=>{s&&Ye.pop(t)}},[s,t,y]);const Fe=c.useRef(null);c.useEffect(()=>{if(!s)return;const l=b=>{const Z=b.target,de=Z.tagName==="INPUT"||Z.tagName==="TEXTAREA"||Z.tagName==="SELECT"||Z.isContentEditable;if(Ye.getTopmostModalId()===t&&(G&&V.trackKeyboard(b),b.type==="keydown")){if(b.key==="Escape"){b.preventDefault(),b.stopPropagation(),de?Z.blur():Ce();return}if(b.key==="Enter"){b.preventDefault(),b.stopPropagation(),de?Z.blur():n?n():Ce();return}}};Fe.current=l;const F=b=>{var Z;(Z=Fe.current)==null||Z.call(Fe,b)};return document.addEventListener("keydown",F,!1),document.addEventListener("keyup",F,!1),()=>{document.removeEventListener("keydown",F,!1),document.removeEventListener("keyup",F,!1)}},[s,t,r,n]);const Tt=c.useCallback(l=>{if(!i&&!l.target.closest("button")&&(document.activeElement instanceof HTMLElement&&document.activeElement.blur(),l.preventDefault(),l.stopPropagation(),h.current)){const F=h.current.getBoundingClientRect();oe===null&&ee({x:F.left,y:F.top}),ce({x:l.clientX-F.left,y:l.clientY-F.top}),ae(!0)}},[i,oe]),be=c.useCallback(l=>{if(!$)return;const F=l.clientX-H.x,b=l.clientY-H.y;ee({x:F,y:b})},[$,H]),Ue=c.useCallback(()=>{ae(!1)},[]);c.useEffect(()=>{s&&(ee(null),ae(!1))},[s]),c.useEffect(()=>($&&!J.current&&(document.addEventListener("mousemove",be),document.addEventListener("mouseup",Ue),J.current=!0),!$&&J.current&&(document.removeEventListener("mousemove",be),document.removeEventListener("mouseup",Ue),J.current=!1),()=>{J.current&&(document.removeEventListener("mousemove",be),document.removeEventListener("mouseup",Ue),J.current=!1)}),[$,be,Ue]),c.useEffect(()=>{if(s)return K.current=document.activeElement,h.current&&h.current.focus(),()=>{var l;(l=K.current)==null||l.focus()}},[s]),c.useEffect(()=>(s?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[s]);const _t=l=>{l.target===l.currentTarget&&f&&Ce()};if(!s)return null;const rt=A||d,Be=Uo(B)?B:null,$t=Be?null:B,wt=oe?{position:"fixed",left:`${oe.x}px`,top:`${oe.y}px`,transform:"none"}:{},St=C.jsx("div",{className:W.modalOverlay,onClick:l=>{l.stopPropagation(),_t(l)},style:{zIndex:rt,alignItems:Bo(O),padding:I},"data-modal-overlay":"true","data-modal-id":t,children:C.jsxs("div",{ref:h,className:`${W.modalContainer} ${oe===null?W["modal--centered"]:""} ${W[`modal--${u}`]} ${S}`,role:"dialog","aria-modal":"true","aria-labelledby":m?"modal-title":void 0,tabIndex:-1,"data-modal-container-id":t,style:{...wt,userSelect:$?"none":"auto",zIndex:rt+1},onMouseDown:l=>{var F;if(l.stopPropagation(),G){const b=l.target,Z=b.tagName.toLowerCase(),de=b.id||b.getAttribute("data-testid")||b.getAttribute("aria-label")||b.getAttribute("name")||((F=b.textContent)==null?void 0:F.trim().substring(0,20))||Z;V.trackClick(de,Z,l)}},onMouseUp:l=>{var pe;const F=l.target,b=F.closest("[data-modal-container-id]"),Z=(b==null?void 0:b.getAttribute("data-modal-container-id"))!==t,de=F.closest(`.${W.modalHeader}`)!==null;if(G&&!Z&&!de){const nt=F.tagName.toLowerCase(),Lt=F.id||F.getAttribute("data-testid")||F.getAttribute("aria-label")||F.getAttribute("name")||((pe=F.textContent)==null?void 0:pe.trim().substring(0,20))||nt;V.trackClick(Lt,nt,l)}!Z&&!$&&l.stopPropagation()},children:[G&&C.jsx(Ft,{ref:v,modalName:o||t,isDarkMode:N,analytics:V,show:G,contextType:"modal"}),(m||x)&&C.jsxs("div",{className:`${W.modalHeader} ${T||""}`,onMouseDown:l=>{var F;if(G){const b=l.target,Z=b.tagName.toLowerCase(),de=b.id||b.getAttribute("data-testid")||b.getAttribute("aria-label")||b.getAttribute("name")||((F=b.textContent)==null?void 0:F.trim().substring(0,20))||Z;V.trackClick(de,Z,l)}Tt(l)},onMouseUp:l=>{var F;if(G){const b=l.target,Z=b.tagName.toLowerCase(),de=b.id||b.getAttribute("data-testid")||b.getAttribute("aria-label")||b.getAttribute("name")||((F=b.textContent)==null?void 0:F.trim().substring(0,20))||Z;V.trackClick(de,Z,l)}},style:{cursor:i?"default":$?"grabbing":"grab",userSelect:"none",paddingTop:G&&w>0?`${w+4}px`:void 0},children:[m&&C.jsx("h2",{id:"modal-title",className:W.modalTitle,children:m}),x&&C.jsx("button",{className:W.modalCloseButton,onClick:()=>{Ce()},"aria-label":g("common.close"),title:`${g("common.close")} (ESC)`,type:"button",children:"Ã—"})]}),C.jsx("div",{className:W.modalBody,children:D?C.jsxs("div",{className:W.modalLoading,children:[C.jsx("div",{className:W.spinner}),C.jsx("p",{children:g("common.loading")||"Loading..."})]}):C.jsxs(C.Fragment,{children:[X&&Te&&C.jsxs("div",{className:W.lockLostBanner,"data-testid":"modal-lock-lost-banner",children:[C.jsx("span",{className:W.lockIcon,role:"img","aria-hidden":"true",children:"âš ï¸"}),C.jsx("span",{children:g("common.locking.lockLost")}),C.jsx("span",{className:W.lockLostHint,children:g("common.locking.lockLostHint")})]}),X&&te&&R&&!Te&&C.jsxs("div",{className:W.lockBanner,"data-testid":"modal-lock-banner",children:[C.jsx("span",{className:W.lockIcon,role:"img","aria-hidden":"true",children:"ğŸ”’"}),C.jsx("span",{children:g("common.locking.editedBy",{name:R.lockedById||g("common.unknown"),time:Ae(R.lockedAt)||g("common.unknown")})}),Ie&&C.jsx("button",{type:"button",className:W.forceUnlockButton,onClick:()=>He(!0),disabled:yt,title:g("common.locking.forceUnlock"),children:C.jsx("span",{role:"img","aria-hidden":"true",children:"ğŸ”“"})})]}),X&&se&&!q?C.jsxs("div",{className:W.lockLoading,"data-testid":"modal-lock-loading",children:[C.jsx("div",{className:W.spinner}),C.jsx("p",{children:g("common.locking.acquiring")})]}):X&&ge?C.jsxs("div",{className:W.lockError,"data-testid":"modal-lock-error",children:[C.jsx("div",{className:W.lockErrorIcon,role:"img","aria-hidden":"true",children:"âš ï¸"}),C.jsx("h3",{className:W.lockErrorTitle,children:g("common.locking.serviceUnavailableTitle")}),C.jsx("p",{className:W.lockErrorMessage,children:g("common.locking.serviceUnavailableMessage")}),C.jsxs("div",{className:W.lockErrorButtons,children:[C.jsx("button",{type:"button",className:W.lockErrorButtonSecondary,onClick:r,children:g("common.locking.closeModal")}),C.jsx("button",{type:"button",className:W.lockErrorButtonPrimary,onClick:ze,children:g("common.locking.retryLock")})]})]}):C.jsx("div",{className:X&&(te||Te)?W.readOnly:void 0,children:_})]})}),B&&C.jsx("div",{className:W.modalFooter,children:Be?C.jsxs("div",{className:W.modalFooterEnhanced,children:[C.jsx("div",{className:W.modalFooterLeft,children:Be.left}),C.jsx("div",{className:W.modalFooterRight,children:Be.right})]}):$t})]})});return C.jsxs(C.Fragment,{children:[kt.createPortal(St,document.body),C.jsx(lt,{isOpen:L.state.isOpen,onClose:L.handleCancel,onConfirm:L.handleConfirm,title:L.state.title,message:L.state.message,parentModalId:t}),C.jsx(lt,{isOpen:xe,onClose:()=>He(!1),onConfirm:Et,title:g("common.locking.forceUnlock"),message:g("common.locking.forceUnlockConfirm",{name:(R==null?void 0:R.lockedById)||g("common.unknown")}),confirmButtonLabel:g("common.locking.forceUnlock"),parentModalId:t})]})},Vo="ConfirmModal-module__content___xH7EG",jo="ConfirmModal-module__message___zmKv-",ct={content:Vo,message:jo},lt=({isOpen:s,onClose:r,onConfirm:n,title:a,message:t,confirmKeyword:y,isDanger:u=!1,confirmButtonLabel:m,cancelButtonLabel:_,secondaryButtonLabel:B,onSecondary:f,isLoading:x=!1,isSecondaryLoading:D=!1,parentModalId:i})=>{const{t:O}=dt(),[I,A]=c.useState(""),[S,E]=c.useState(!1),o=!u,T=`confirm-modal-${i||"root"}`,e=y||(u?O("components.modalV3.confirmModal.danger.confirmKeyword"):""),p=c.useRef(s);c.useEffect(()=>{s&&!p.current&&(A(""),E(!1)),p.current=s},[s]);const g=()=>{if(o){n();return}const L=I.trim().toLowerCase(),h=e.toLowerCase();L===h?n():E(!0)},j=L=>{L.key==="Enter"&&(L.preventDefault(),L.stopPropagation(),g())};return C.jsx(Po,{isOpen:s,onClose:r,onConfirm:g,modalId:T,parentModalId:i,title:a||O(u?"components.modalV3.confirmModal.danger.defaultTitle":"components.modalV3.confirmModal.simple.defaultTitle"),size:"sm",footer:{right:C.jsxs(C.Fragment,{children:[C.jsx(Ge,{variant:"ghost",onClick:r,disabled:x||D,"data-testid":"confirm-modal-cancel",children:_||O("components.modalV3.confirmModal.simple.defaultCancel")}),B&&f&&C.jsx(Ge,{variant:"secondary",onClick:f,loading:D,disabled:x,"data-testid":"confirm-modal-secondary",children:B}),C.jsx(Ge,{variant:u?"danger":"primary",onClick:g,loading:x,disabled:D,"data-testid":"confirm-modal-confirm",children:m||O(u?"components.modalV3.confirmModal.danger.defaultConfirm":"components.modalV3.confirmModal.simple.defaultConfirm")})]})},children:C.jsxs("div",{className:ct.content,children:[C.jsx("div",{className:ct.message,children:t||(u&&e?O("components.modalV3.confirmModal.danger.defaultMessage",{keyword:e}):O("components.modalV3.confirmModal.simple.defaultMessage"))}),!o&&!!e&&C.jsx(Ut,{label:O("components.modalV3.confirmModal.danger.keywordLabel",{keyword:e}),error:S?O("components.modalV3.confirmModal.danger.keywordError",{keyword:e}):void 0,reserveMessageSpace:!0,value:I,onChange:L=>{A(L.target.value),E(!1)},children:C.jsx(bt,{type:"text",placeholder:O("components.modalV3.confirmModal.danger.keywordPlaceholder",{keyword:e}),onKeyDown:j,autoFocus:!0})})]})})};export{lt as C,Po as M,Jt as u};
