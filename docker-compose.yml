# ================================================================
# L-KERN v4 - Docker Compose Configuration
# ================================================================
# Version: 1.0.0
# Created: 2025-10-13
#
# Configuration: .env file
# Port Mapping: docs/architecture/port-mapping.md
#
# All values are loaded from .env - NO hardcoded values!
# ================================================================


# ================================================================
# NETWORKS
# ================================================================
networks:
  backend:
    driver: bridge
    name: ${NETWORK_BACKEND}
  database:
    driver: bridge
    name: ${NETWORK_DATABASE}

# ================================================================
# VOLUMES
# ================================================================
volumes:
  lkms101_db_data:
    name: ${LKMS101_DB_VOLUME}
  lkms105_db_data:
    name: ${LKMS105_DB_VOLUME}
  lkms105_minio_data:
    name: ${LKMS105_MINIO_VOLUME:-lkern_lkms105_minio_data}
  node_modules:
    name: ${VOLUME_NODE_MODULES}
  postgres_data:
    name: ${LKMS501_VOLUME_DATA}
  zookeeper_data:
    name: ${LKMS503_VOLUME_DATA}
  zookeeper_logs:
    name: ${LKMS503_VOLUME_LOGS}
  kafka_data:
    name: ${LKMS504_VOLUME_DATA}

# ================================================================
# SERVICES
# ================================================================
services:

  # ============================================================
  # FRONTEND APPLICATIONS (LKMS 200-299)
  # ============================================================

  lkms201-web-ui:
    build:
      context: .
      dockerfile: ${LKMS201_DOCKERFILE}
    container_name: ${LKMS201_CONTAINER_NAME}
    restart: ${LKMS201_RESTART_POLICY}
    environment:
      - SERVICE_NAME=${LKMS201_SERVICE_NAME}
      - SERVICE_VERSION=${LKMS201_VERSION}
      - NODE_ENV=${NODE_ENV}
      - VITE_PORT=${LKMS201_VITE_PORT}
      - VITE_HOST=${LKMS201_VITE_HOST}
      - VITE_API_CONTACTS=${VITE_API_CONTACTS}
      - VITE_API_ORDERS=${VITE_API_ORDERS}
      - VITE_API_AUTH=${VITE_API_AUTH}
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=1000
      # Nx daemon disabled for local development (Docker + Windows volumes issues)
      # Enable in CI/CD production builds for faster task execution
      - NX_DAEMON=false
      - NX_SKIP_NX_CACHE=true
      - NX_PARALLEL=1
      - NX_NO_CLOUD=true
    ports:
      - "${LKMS201_PORT_EXTERNAL}:${LKMS201_PORT_INTERNAL}"
    volumes:
      # Source code (hot-reload - read-write for file watching)
      - ./apps:/app/apps
      - ./packages:/app/packages
      - ./nx.json:/app/nx.json
      - ./tsconfig.base.json:/app/tsconfig.base.json
      # NOTE: Do NOT mount package.json, yarn.lock, .yarnrc.yml, .yarn
      # Dockerfile creates its own .yarnrc.yml without yarnPath
      # Preserve node_modules (from Docker image)
      - node_modules:/app/node_modules
    networks:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${LKMS201_PORT_INTERNAL}"]
      interval: ${LKMS201_HEALTHCHECK_INTERVAL}
      timeout: ${LKMS201_HEALTHCHECK_TIMEOUT}
      retries: ${LKMS201_HEALTHCHECK_RETRIES}
      start_period: ${LKMS201_HEALTHCHECK_START_PERIOD}

  # ============================================================
  # BUSINESS MICROSERVICES (LKMS 100-199)
  # ============================================================

  # lkms101-contacts:
  #   build:
  #     context: .
  #     dockerfile: ${LKMS101_DOCKERFILE}
  #   container_name: ${LKMS101_CONTAINER_NAME}
  #   restart: ${LKMS101_RESTART_POLICY}
  #   environment:
  #     - SERVICE_NAME=${LKMS101_SERVICE_NAME}
  #     - SERVICE_VERSION=${LKMS101_VERSION}
  #     - SERVER_HOST=${LKMS101_SERVER_HOST}
  #     - SERVER_RELOAD=${LKMS101_SERVER_RELOAD}
  #     - LOG_LEVEL=${LKMS101_LOG_LEVEL}
  #     - DEBUG=${LKMS101_DEBUG}
  #     - DATABASE_HOST=${LKMS101_DB_HOST}
  #     - DATABASE_PORT=${LKMS101_DB_PORT}
  #     - DATABASE_NAME=${LKMS101_DB_NAME}
  #     - DATABASE_USER=${LKMS101_DB_USER}
  #     - DATABASE_PASSWORD=${LKMS101_DB_PASSWORD}
  #     - CORS_ORIGINS=${CORS_ORIGINS_DEV}
  #     - CORS_MAX_AGE=${CORS_MAX_AGE}
  #     - CORS_ALLOW_CREDENTIALS=${CORS_ALLOW_CREDENTIALS}
  #   ports:
  #     - "${LKMS101_PORT_EXTERNAL}:${LKMS101_PORT_INTERNAL}"
  #   volumes:
  #     - ./services/lkms101-contacts/src:/app/src:ro
  #     - ./packages:/app/packages:ro
  #   networks:
  #     - backend
  #     - database
  #   depends_on:
  #     lkms501-postgres:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:${LKMS101_PORT_INTERNAL}/health"]
  #     interval: ${LKMS101_HEALTHCHECK_INTERVAL}
  #     timeout: ${LKMS101_HEALTHCHECK_TIMEOUT}
  #     retries: ${LKMS101_HEALTHCHECK_RETRIES}
  #     start_period: ${LKMS101_HEALTHCHECK_START_PERIOD}

  # ============================================================
  # DATA SERVICES (LKMS 500-599)
  # ============================================================

  # lkms501-postgres:
  #   image: ${LKMS501_IMAGE}
  #   container_name: ${LKMS501_CONTAINER_NAME}
  #   restart: ${LKMS501_RESTART_POLICY}
  #   environment:
  #     - POSTGRES_USER=${LKMS501_POSTGRES_USER}
  #     - POSTGRES_PASSWORD=${LKMS501_POSTGRES_PASSWORD}
  #     - POSTGRES_DB=${LKMS501_POSTGRES_DB}
  #   ports:
  #     - "${LKMS501_PORT_EXTERNAL}:${LKMS501_PORT_INTERNAL}"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - database
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${LKMS501_POSTGRES_USER}"]
  #     interval: ${LKMS501_HEALTHCHECK_INTERVAL}
  #     timeout: ${LKMS501_HEALTHCHECK_TIMEOUT}
  #     retries: ${LKMS501_HEALTHCHECK_RETRIES}

  # ============================================================
  # DEVELOPMENT TOOLS (LKMS 900-999)
  # ============================================================

  # === DOCUMENTATION (Docusaurus + Storybook) ===
  lkms902-docs:
    build:
      context: .
      dockerfile: ${LKMS902_DOCKERFILE}
    container_name: ${LKMS902_CONTAINER_NAME}
    restart: ${LKMS902_RESTART_POLICY}
    environment:
      - SERVICE_NAME=${LKMS902_SERVICE_NAME}
      - SERVICE_VERSION=${LKMS902_VERSION}
      - NODE_ENV=${NODE_ENV}
      - DOCS_PORT=${LKMS902_PORT_INTERNAL}
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=1000
      - NX_DAEMON=false
      - NX_SKIP_NX_CACHE=true
    ports:
      - "${LKMS902_PORT_EXTERNAL}:${LKMS902_PORT_INTERNAL}"
    volumes:
      # Source code (hot-reload)
      - ./apps:/app/apps
      - ./packages:/app/packages
      - ./nx.json:/app/nx.json
      - ./tsconfig.base.json:/app/tsconfig.base.json
      # Preserve node_modules (from Docker image)
      - node_modules:/app/node_modules
    networks:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${LKMS902_PORT_INTERNAL}"]
      interval: ${LKMS902_HEALTHCHECK_INTERVAL}
      timeout: ${LKMS902_HEALTHCHECK_TIMEOUT}
      retries: ${LKMS902_HEALTHCHECK_RETRIES}
      start_period: ${LKMS902_HEALTHCHECK_START_PERIOD}

  lkms901-adminer:
    image: ${LKMS901_IMAGE}
    container_name: ${LKMS901_CONTAINER_NAME}
    restart: ${LKMS901_RESTART_POLICY}
    environment:
      - ADMINER_DEFAULT_SERVER=${LKMS901_DEFAULT_SERVER}
      - ADMINER_DESIGN=${LKMS901_DESIGN}
    ports:
      - "${LKMS901_PORT_EXTERNAL}:${LKMS901_PORT_INTERNAL}"
    networks:
      - database
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:${LKMS901_PORT_INTERNAL}/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s



  # ================================================================
  # Issues Service - PostgreSQL Database
  # ================================================================
  lkms105-issues-db:
    image: ${LKMS105_DB_IMAGE}
    container_name: ${LKMS105_DB_CONTAINER_NAME}
    environment:
      POSTGRES_DB: ${LKMS105_DB_NAME}
      POSTGRES_USER: ${LKMS105_DB_USER}
      POSTGRES_PASSWORD: ${LKMS105_DB_PASSWORD}
    volumes:
      - lkms105_db_data:/var/lib/postgresql/data
    networks:
      - database
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${LKMS105_DB_USER} -d ${LKMS105_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  lkms105-minio:
    image: minio/minio:latest
    container_name: lkms105-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${LKMS105_MINIO_ROOT_USER:-lkern_admin}
      MINIO_ROOT_PASSWORD: ${LKMS105_MINIO_ROOT_PASSWORD:-lkern_dev_password_2024}
    ports:
      - "9105:9000"   # MinIO API
      - "9106:9001"   # MinIO Console
    volumes:
      - lkms105_minio_data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ================================================================
  # Message Broker - Zookeeper & Kafka
  # ================================================================
  lkms503-zookeeper:
    image: ${LKMS503_IMAGE}
    container_name: ${LKMS503_CONTAINER_NAME}
    restart: ${LKMS503_RESTART_POLICY}
    environment:
      ZOOKEEPER_CLIENT_PORT: ${LKMS503_CLIENT_PORT}
      ZOOKEEPER_TICK_TIME: ${LKMS503_TICK_TIME}
      ZOOKEEPER_SERVER_ID: ${LKMS503_SERVER_ID}
    ports:
      - "${LKMS503_PORT_EXTERNAL}:${LKMS503_PORT_INTERNAL}"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    networks:
      - backend
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: ${LKMS503_HEALTHCHECK_INTERVAL}
      timeout: ${LKMS503_HEALTHCHECK_TIMEOUT}
      retries: ${LKMS503_HEALTHCHECK_RETRIES}
      start_period: ${LKMS503_HEALTHCHECK_START_PERIOD}

  lkms504-kafka:
    image: ${LKMS504_IMAGE}
    container_name: ${LKMS504_CONTAINER_NAME}
    restart: ${LKMS504_RESTART_POLICY}
    depends_on:
      lkms503-zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: ${LKMS504_BROKER_ID}
      KAFKA_ZOOKEEPER_CONNECT: ${LKMS504_ZOOKEEPER_CONNECT}
      KAFKA_ADVERTISED_LISTENERS: ${LKMS504_ADVERTISED_LISTENERS}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: ${LKMS504_LISTENER_SECURITY_PROTOCOL_MAP}
      KAFKA_INTER_BROKER_LISTENER_NAME: ${LKMS504_INTER_BROKER_LISTENER_NAME}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: ${LKMS504_OFFSETS_TOPIC_REPLICATION_FACTOR}
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: ${LKMS504_AUTO_CREATE_TOPICS_ENABLE}
    ports:
      - "${LKMS504_PORT_EXTERNAL}:${LKMS504_PORT_INTERNAL}"
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - backend
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: ${LKMS504_HEALTHCHECK_INTERVAL}
      timeout: ${LKMS504_HEALTHCHECK_TIMEOUT}
      retries: ${LKMS504_HEALTHCHECK_RETRIES}
      start_period: ${LKMS504_HEALTHCHECK_START_PERIOD}

  # ================================================================
  # Issues Service - FastAPI Application
  # ================================================================
  lkms105-issues:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.backend.dev
      args:
        SERVICE_PATH: services/lkms105-issues
    container_name: ${LKMS105_CONTAINER_NAME}
    depends_on:
      lkms105-issues-db:
        condition: service_healthy
      lkms105-minio:
        condition: service_healthy
    environment:
      - SERVICE_NAME=Issues Service
      - REST_PORT=${LKMS105_REST_PORT}
      - GRPC_PORT=${LKMS105_GRPC_PORT}
      - DB_HOST=lkms105-issues-db
      - DB_PORT=5432
      - DB_NAME=${LKMS105_DB_NAME}
      - DB_USER=${LKMS105_DB_USER}
      - DB_PASSWORD=${LKMS105_DB_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=lkms504-kafka:9092
      - MINIO_HOST=lkms105-minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=${LKMS105_MINIO_ROOT_USER:-lkern_admin}
      - MINIO_SECRET_KEY=${LKMS105_MINIO_ROOT_PASSWORD:-lkern_dev_password_2024}
      - MINIO_BUCKET=issues-attachments
    ports:
      - "${LKMS105_REST_PORT_EXTERNAL}:${LKMS105_REST_PORT}"
      - "${LKMS105_GRPC_PORT_EXTERNAL}:${LKMS105_GRPC_PORT}"
    volumes:
      - ./services/lkms105-issues:/app
    networks:
      - backend
      - database
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:${LKMS105_REST_PORT}/health').read()\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped



  # ================================================================
  # Contact Service (MDM) - PostgreSQL Database
  # ================================================================
  lkms101-contacts-db:
    image: ${LKMS101_DB_IMAGE}
    container_name: ${LKMS101_DB_CONTAINER_NAME}
    environment:
      POSTGRES_DB: ${LKMS101_DB_NAME}
      POSTGRES_USER: ${LKMS101_DB_USER}
      POSTGRES_PASSWORD: ${LKMS101_DB_PASSWORD}
    volumes:
      - lkms101_db_data:/var/lib/postgresql/data
    networks:
      - database
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${LKMS101_DB_USER} -d ${LKMS101_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ================================================================
  # Contact Service (MDM) - FastAPI Application
  # ================================================================
  lkms101-contacts:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.backend.dev
      args:
        SERVICE_PATH: services/lkms101-contacts
    container_name: ${LKMS101_CONTAINER_NAME}
    depends_on:
      lkms101-contacts-db:
        condition: service_healthy
    environment:
      - SERVICE_NAME=Contact Service (MDM)
      - REST_PORT=${LKMS101_REST_PORT}
      - GRPC_PORT=${LKMS101_GRPC_PORT}
      - DB_HOST=lkms101-contacts-db
      - DB_PORT=5432
      - DB_NAME=${LKMS101_DB_NAME}
      - DB_USER=${LKMS101_DB_USER}
      - DB_PASSWORD=${LKMS101_DB_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=lkms504-kafka:9092
    ports:
      - "${LKMS101_REST_PORT_EXTERNAL}:${LKMS101_REST_PORT}"
      - "${LKMS101_GRPC_PORT_EXTERNAL}:${LKMS101_GRPC_PORT}"
    volumes:
      - ./services/lkms101-contacts:/app
    networks:
      - backend
      - database
    restart: unless-stopped

# ================================================================
# USAGE
# ================================================================
#
# üöÄ START:
#   docker-compose up -d
#
# üî® REBUILD:
#   docker-compose up --build -d
#
# üìä LOGS:
#   docker-compose logs -f lkms201-web-ui
#
# üîÑ RESTART:
#   docker-compose restart lkms201-web-ui
#
# üõë STOP:
#   docker-compose down
#
# üóëÔ∏è CLEAN:
#   docker-compose down -v
#
# ‚öôÔ∏è ENABLE/DISABLE SERVICES:
#   Edit .env file: LKMS{XXX}_ENABLED=true/false
#   Uncomment service in this file
#
# üìã ACCESS:
#   Web UI:    http://localhost:4201
#   Contacts:  http://localhost:4101/docs
#   Postgres:  localhost:4501
#   Adminer:   http://localhost:4901
#
# ================================================================